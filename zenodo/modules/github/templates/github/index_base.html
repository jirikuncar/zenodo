{#
## This file is part of Invenio.
## Copyright (C) 2013, 2014 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}

{% extends "page.html" %}

{% block title %}{% endblock %}

{% block javascript %}

{{super()}}
<script type="text/javascript">
$(document).ready(function() {
  
  // Initialize bootstrap switches
  var doiSwitches = $("input[data-repo-name]").bootstrapSwitch();
  doiSwitches.on("switchChange", function(e, data) {
    var state = data.value;
    var repoName = data.el[0].dataset.repoName;
    
    // Post to Zenodo
    endpoint = state ? "create-github-hook/" : "remove-github-hook/"
    $.ajax({
      url: endpoint + repoName,
      type: "POST",
      dataType: "json",
      success: function(data, textStatus, jqXHR) {
        
        // TODO: Provide feedback to user about the state of the hook
        var feedback = (data.state === "added") ? "GitHub Hook added successfully." : "GitHub Hook removed successfully.";
        alert(feedback);
        
      }
    });
    
  });
  
  
  // Select DOM elements
  var githubButtonEl = $("button[name='connect-to-github']");
  githubButtonEl.on("click", function() {
    window.location = "/github/connect";
  });
  
  var testEl = $("button[name='test-deposition']")
  testEl.on("click", function() {
    var payload = {"action":"published","release":{"url":"https://api.github.com/repos/kapadia/zenodo-test/releases/184680","assets_url":"https://api.github.com/repos/kapadia/zenodo-test/releases/184680/assets","upload_url":"https://uploads.github.com/repos/kapadia/zenodo-test/releases/184680/assets{?name}","html_url":"https://github.com/kapadia/zenodo-test/releases/tag/0.0.8","id":184680,"tag_name":"0.0.8","target_commitish":"master","name":"Zenodo Test","body":"# Zenodo Test\r\n\r\nHere's some markdown to go with it\r\n\r\n  * one\r\n  * two\r\n  * three","draft":false,"author":{"login":"kapadia","id":581337,"avatar_url":"https://gravatar.com/avatar/175f04a31874cda4acefc1d13897b530?d=https%3A%2F%2Fidenticons.github.com%2F88768eebbf4d131227fa768937006d69.png&r=x","gravatar_id":"175f04a31874cda4acefc1d13897b530","url":"https://api.github.com/users/kapadia","html_url":"https://github.com/kapadia","followers_url":"https://api.github.com/users/kapadia/followers","following_url":"https://api.github.com/users/kapadia/following{/other_user}","gists_url":"https://api.github.com/users/kapadia/gists{/gist_id}","starred_url":"https://api.github.com/users/kapadia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kapadia/subscriptions","organizations_url":"https://api.github.com/users/kapadia/orgs","repos_url":"https://api.github.com/users/kapadia/repos","events_url":"https://api.github.com/users/kapadia/events{/privacy}","received_events_url":"https://api.github.com/users/kapadia/received_events","type":"User","site_admin":false},"prerelease":false,"created_at":"2014-02-13T14:53:04Z","published_at":"2014-02-13T14:58:46Z","assets":[],"tarball_url":"https://api.github.com/repos/kapadia/zenodo-test/tarball/0.0.8","zipball_url":"https://api.github.com/repos/kapadia/zenodo-test/zipball/0.0.8"},"repository":{"id":16761134,"name":"zenodo-test","full_name":"kapadia/zenodo-test","owner":{"login":"kapadia","id":581337,"avatar_url":"https://gravatar.com/avatar/175f04a31874cda4acefc1d13897b530?d=https%3A%2F%2Fidenticons.github.com%2F88768eebbf4d131227fa768937006d69.png&r=x","gravatar_id":"175f04a31874cda4acefc1d13897b530","url":"https://api.github.com/users/kapadia","html_url":"https://github.com/kapadia","followers_url":"https://api.github.com/users/kapadia/followers","following_url":"https://api.github.com/users/kapadia/following{/other_user}","gists_url":"https://api.github.com/users/kapadia/gists{/gist_id}","starred_url":"https://api.github.com/users/kapadia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kapadia/subscriptions","organizations_url":"https://api.github.com/users/kapadia/orgs","repos_url":"https://api.github.com/users/kapadia/repos","events_url":"https://api.github.com/users/kapadia/events{/privacy}","received_events_url":"https://api.github.com/users/kapadia/received_events","type":"User","site_admin":false},"private":false,"html_url":"https://github.com/kapadia/zenodo-test","description":"","fork":false,"url":"https://api.github.com/repos/kapadia/zenodo-test","forks_url":"https://api.github.com/repos/kapadia/zenodo-test/forks","keys_url":"https://api.github.com/repos/kapadia/zenodo-test/keys{/key_id}","collaborators_url":"https://api.github.com/repos/kapadia/zenodo-test/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/kapadia/zenodo-test/teams","hooks_url":"https://api.github.com/repos/kapadia/zenodo-test/hooks","issue_events_url":"https://api.github.com/repos/kapadia/zenodo-test/issues/events{/number}","events_url":"https://api.github.com/repos/kapadia/zenodo-test/events","assignees_url":"https://api.github.com/repos/kapadia/zenodo-test/assignees{/user}","branches_url":"https://api.github.com/repos/kapadia/zenodo-test/branches{/branch}","tags_url":"https://api.github.com/repos/kapadia/zenodo-test/tags","blobs_url":"https://api.github.com/repos/kapadia/zenodo-test/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/kapadia/zenodo-test/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/kapadia/zenodo-test/git/refs{/sha}","trees_url":"https://api.github.com/repos/kapadia/zenodo-test/git/trees{/sha}","statuses_url":"https://api.github.com/repos/kapadia/zenodo-test/statuses/{sha}","languages_url":"https://api.github.com/repos/kapadia/zenodo-test/languages","stargazers_url":"https://api.github.com/repos/kapadia/zenodo-test/stargazers","contributors_url":"https://api.github.com/repos/kapadia/zenodo-test/contributors","subscribers_url":"https://api.github.com/repos/kapadia/zenodo-test/subscribers","subscription_url":"https://api.github.com/repos/kapadia/zenodo-test/subscription","commits_url":"https://api.github.com/repos/kapadia/zenodo-test/commits{/sha}","git_commits_url":"https://api.github.com/repos/kapadia/zenodo-test/git/commits{/sha}","comments_url":"https://api.github.com/repos/kapadia/zenodo-test/comments{/number}","issue_comment_url":"https://api.github.com/repos/kapadia/zenodo-test/issues/comments/{number}","contents_url":"https://api.github.com/repos/kapadia/zenodo-test/contents/{+path}","compare_url":"https://api.github.com/repos/kapadia/zenodo-test/compare/{base}...{head}","merges_url":"https://api.github.com/repos/kapadia/zenodo-test/merges","archive_url":"https://api.github.com/repos/kapadia/zenodo-test/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/kapadia/zenodo-test/downloads","issues_url":"https://api.github.com/repos/kapadia/zenodo-test/issues{/number}","pulls_url":"https://api.github.com/repos/kapadia/zenodo-test/pulls{/number}","milestones_url":"https://api.github.com/repos/kapadia/zenodo-test/milestones{/number}","notifications_url":"https://api.github.com/repos/kapadia/zenodo-test/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/kapadia/zenodo-test/labels{/name}","releases_url":"https://api.github.com/repos/kapadia/zenodo-test/releases{/id}","created_at":"2014-02-12T08:44:35Z","updated_at":"2014-02-13T14:58:03Z","pushed_at":"2014-02-13T14:58:03Z","git_url":"git://github.com/kapadia/zenodo-test.git","ssh_url":"git@github.com:kapadia/zenodo-test.git","clone_url":"https://github.com/kapadia/zenodo-test.git","svn_url":"https://github.com/kapadia/zenodo-test","homepage":null,"size":0,"stargazers_count":0,"watchers_count":0,"language":null,"has_issues":true,"has_downloads":true,"has_wiki":true,"forks_count":0,"mirror_url":null,"open_issues_count":0,"forks":0,"open_issues":0,"watchers":0,"default_branch":"master","master_branch":"master"},"sender":{"login":"kapadia","id":581337,"avatar_url":"https://gravatar.com/avatar/175f04a31874cda4acefc1d13897b530?d=https%3A%2F%2Fidenticons.github.com%2F88768eebbf4d131227fa768937006d69.png&r=x","gravatar_id":"175f04a31874cda4acefc1d13897b530","url":"https://api.github.com/users/kapadia","html_url":"https://github.com/kapadia","followers_url":"https://api.github.com/users/kapadia/followers","following_url":"https://api.github.com/users/kapadia/following{/other_user}","gists_url":"https://api.github.com/users/kapadia/gists{/gist_id}","starred_url":"https://api.github.com/users/kapadia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kapadia/subscriptions","organizations_url":"https://api.github.com/users/kapadia/orgs","repos_url":"https://api.github.com/users/kapadia/repos","events_url":"https://api.github.com/users/kapadia/events{/privacy}","received_events_url":"https://api.github.com/users/kapadia/received_events","type":"User","site_admin":false}};
    
    $.ajax({
      url: "create-deposition/pyavm",
      type: "POST",
      dataType: "json",
      contentType:"application/json",
      data: JSON.stringify(payload),
      success: function(data, textStatus, jqXHR) {
        
        // TODO: Provide feedback to user about the state of the hook
        var feedback = (data.state === "added") ? "GitHub Hook added successfully." : "GitHub Hook removed successfully.";
        alert(feedback);
        
      }
    });
    
  });
  
});
</script>
{% endblock %}

{% block body %}
<div class="row" id="file_container">
    <div class="col-sm-6 col-md-8">
      {% if connected %}
      <h3>GitHub Projects</h3>
      
      <p>Apply a persistent research identifier to your GitHub projects.</p> 
      
      <button name="test-deposition" type="submit" class="btn btn-default">Test Desposition</button>
      
      {% for repo, description in repos.iteritems() %}
      <dl class="dl-horizontal">
        <dt>{{repo}}</dt>
        <dd>
          <input type="checkbox" {{ 'checked' if description.hook }} data-size="mini" data-animate="true" data-label-text="DOI" data-repo-name="{{repo}}">
        </dd>
      </dl>
      {% endfor %}
      
      {% else %}
      <button name="connect-to-github" type="submit" class="btn btn-default"><i class="icon-fa-github"></i> Connect to GitHub</button>
      {% endif %}
    </div>
    <div class="col-sm-6 col-md-4">
    </div>
</div>
{% endblock %}