{#
## This file is part of Invenio.
## Copyright (C) 2013, 2014 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}

{%- import "accounts/settings/helpers.html" as helpers with context %}
{%- extends "accounts/settings/index.html" %}

{% block title %}{% endblock %}

{% block javascript %}

{{super()}}
<script type="text/javascript">
$(document).ready(function() {

  // Initialize bootstrap switches
  var doiSwitches = $("input[data-repo-name]").bootstrapSwitch();
  doiSwitches.on("switchChange", function(e, data) {
    var state = data.value;
    var repoName = data.el[0].dataset.repoName;

    console.log("HERE", repoName);

    // Post to Zenodo
    var endpoint = state ? "create-github-hook/" : "remove-github-hook/"
    console.log("POSTING to ", endpoint);
    $.ajax({
      url: endpoint,
      type: "POST",
      data: JSON.stringify({repo: repoName}),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(data, textStatus, jqXHR) {
        console.log(data);
        // TODO: Provide feedback to user about the state of the hook
        var status = (data.status) ? "fa-check" : "fa-exclamation";

        // Select the correct toggle
        var el = $("[data-repo='" + repoName + "'] .hook-status");
        el.addClass(status);
        el.animate({
          opacity: 0
        }, 2000, function() {
          el.removeClass(status);
          el.css('opacity', 1);
        });

      }
    });

  });


  // Select DOM elements
  var githubButtonEl = $("button[name='connect-to-github']");
  githubButtonEl.on("click", function() {
    window.location = "{{url_for('zenodo_github.connect')}}";
  });

  var syncButton = $("span[name='sync-repos']");
  syncButton.on("click", function() {

    $.ajax({
      url: "/github/sync",
      type: "GET",
      dataType: "json",
      success: function(data, textStatus, jqXHR) {

        // TODO: Update DOM

      }
    });

  });

  $("i.error").tooltip({
    trigger: "hover",
    animation: true,
    placement: "top",
  });

});
</script>
{% endblock %}

{% block settings_body %}
{% if connected %}
{{helpers.panel_start(
    _('%(icon)s GitHub Repositories')|format(icon='<i class="fa fa-github"></i>')|safe,
    with_body=False,
    btn='Sync ...',
    btn_icon='fa fa-refresh',
    btn_name='sync-repos',
    btn_text=_('(updated %(last_sync)s) ')|format(last_sync=last_sync),
)}}
<div class="panel-body">
<h4>Get started</h4>
<div class="row">
    <div class="col-md-4">
    <h1><strong>1</strong></h1> Flip the switch
    </div>
    <div class="col-md-4">
    2 Release
    </div>
    <div class="col-md-4">
    3 Get the badge
    </div>
</div>
</div>
<table class="table table-striped">
  <tbody>
  {% for repo, description in repos.iteritems() %}
  <tr>
    <td>
      <h4 class="repo">{{repo}} <small>{{description.doi}}</small></h4>
      <small class="text-muted repo-description"> {{description.description}}</small>
    </td>
    <td>
      <div class="doi-toggle">
        {% if description.errors %}
        <a href="deposit/{{description.deposition_id}}/">
          <i
            class="error fa fa-exclamation-circle"
            data-toggle="tooltip"
            {% if description.errors[0].code %}
            title="Missing metadata."
            {% else %}
            title="{{description.errors | map(attribute='message') | join(',' )}}"
            {% endif %}
          ></i>
        </a>
        {% endif %}
        <input type="checkbox" {{ 'checked' if description.hook }} data-size="mini" data-animate="true" data-repo-name="{{repo}}">
        <i class="hook-status fa"></i>
        <br/>
        <small class="text-muted doi-time"> {{description.modified|naturaltime if description.get('modified') else ''}}</small>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{{helpers.panel_end(with_body=False)}}
{% else %}
{{helpers.panel_start(
    _('%(icon)s GitHub')|format(icon='<i class="fa fa-github"></i>')|safe,
)}}
<div class="row" align="center">
    <h1>Software preservation made simple!</h1>
    <div style="margin: 50px;">
        <button name="connect-to-github" type="submit" class="btn btn-default btn-lg"><i class="fa fa-github fa-lg"></i> Connect</button>
    </div>
    <p class="text-muted">
    To get started, click "Connect" and we will get a list your repositories from GitHub.</p>
</div>
{{helpers.panel_end()}}
{% endif %}
{% endblock %}